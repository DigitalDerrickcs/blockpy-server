{% extends 'layout.html' %}

{% block title %}
Courses: Index
{% endblock %}

{% block statusbar %}
{% endblock %}

{% block extrahead %}

<script src="{{ url_for('static', filename='libs/knockout-3.4.0.js') }}" ></script>

<script type='text/javascript'>

$(document).ready(function() {
    $(".maze-selected").click(function() {
        var maze_id = $(this).data('maze');
        // TODO: This does not work with shared
        $.get("{{ url_for('assignments.select_builtin_assignment') }}", 
            {'assignment_id': maze_id,
             'course_id': {{ course.id|tojson }},
             'assignment_type': 'maze'},
            function(data) {
                var redirect_url = "{{ return_url }}?url="+data.url+"&return_type={{ 'lti_launch_url' if menu != 'share' else 'iframe' }}&title=maze"+maze_id+"&text=BlockPy%20Exercise&width=100%25&height=600";
                window.location.href = redirect_url;
            }
        );
    });
});

function MainModel() {
    var self = this;
    self.groups = ko.observableArray([
    {
        'name': ko.observable('Ungrouped Assignments'),
        'id': -1,
        'position': ko.observable(-1),
        'assignments': ko.observableArray([
        {% for assignment in strays %}
            {
                'id': {{ assignment.id }},
                'name': ko.observable({{ assignment.name|tojson }}),
                'group_id': -1,
                'position': ko.observable({{ assignment.position|tojson }}),
                'type': ko.observable({{assignment.type|tojson}}),
                'title': ko.observable({{assignment.title()|tojson}}),
                'view': ko.observable({{ url_for('assignments.load', assignment_id=assignment.id )|tojson }}),
                'edit': {{ url_for('assignments.edit_assignment', assignment_id=assignment.id )|tojson }},
                'modified': ko.observable({{ assignment.date_modified.strftime(" %I:%M%p on %a %d, %b %Y").replace(" 0", " ")|tojson }}),
                'body': ko.observable({{ assignment.body|striptags|truncate(255)|tojson }})
            }{{ "," if not loop.last }}
        {% endfor %}
        ])
    },
    {% for group, assignments in groups %}
    {
        'name': ko.observable("{{ group.name }}"),
        'id': {{ group.id }},
        'position': ko.observable({{ group.position|tojson }}),
        'assignments': ko.observableArray([
            {% for assignment in assignments %}
            {
                'name': ko.observable("{{ assignment.name }}"),
                'position': ko.observable({{ assignment.position|tojson }}),
                'id': {{ assignment.id }},
                'group_id': {{ group.id }},
                'title': ko.observable("{{assignment.title()}}"),
                'type': ko.observable({{assignment.type|tojson}}),
                'view': ko.observable({{ url_for('assignments.load', assignment_id=assignment.id )|tojson }}),
                'select': "{{ return_url }}?url={{url_for('assignments.load' if menu != 'share' else 'assignments.shared', assignment_id=assignment.id, _external=True) | urlencode}}&return_type={{ 'lti_launch_url' if menu != 'share' else 'iframe' }}&title={{ assignment.title()|urlencode }}&text=BlockPy%20Exercise&width=100%25&height=600", 
                'edit': "{{ url_for('assignments.edit_assignment', assignment_id=assignment.id ) }}",
                'modified': ko.observable('{{ assignment.date_modified.strftime(" %I:%M%p on %a %d, %b %Y").replace(" 0", " ") }}'),
                'body': ko.observable("{{ assignment.body|striptags|truncate(255) }}")
            }{{ "," if not loop.last }}
            {% endfor %}
            
        ])
    }{{ ',' if not loop.last}}
    {% endfor %}
    ]);
    self.strayGroup = self.groups()[0];
    
    self.moveMembership = function(assignment, old_group, new_group) {
        $.post("{{ url_for('assignment_group.move_membership') }}", {
                'new_group_id': new_group.id,
                'course_id': {{ course.id|tojson }},
                'assignment_id': assignment.id
           }, function(data) {
            if (data.success) {
                var original_entry = old_group.assignments.remove(
                    function(item) {return item.id == assignment.id});
                if (original_entry.length == 0) {
                    console.error("Couldn't find assignment!")
                } else {
                    new_group.assignments.push(original_entry[0]);
                    assignment.group_id = new_group.id;
                }
            } else {
                console.error(data.message);
            }
        });
    };
    
    self.group_comparison = function(left, right) {
        /*if (left.position() == -1) {
            return 1;
        } else if (right.position() == -1) {
            return -1;
        } else if (left.position() != right.position()) {
            return left.position() - right.position();*/
        if (left.id == -1) {
            return 1;
        } else if (right.id == -1) {
            return -1;
        } else if (left.name() != right.name()) {
            return left.name() - right.name();
        } else {
            return left.id - right.id;
        }
    }
    self.groups.sort(self.group_comparison);
    
    self.renameGroup = function(group) {
        new_name = window.prompt("Give a new name for this group:", group.name())
        if (new_name != null) {
            $.post("{{ url_for('assignment_group.edit_group') }}", {
                'new_name': new_name,
                'course_id': {{ course.id|tojson }},
                'assignment_group_id': group.id
            }, function(data) {
                if (data.success) {
                    group.name(new_name);
                    self.groups.sort(self.group_comparison);
                } else {
                    console.error(data.message);
                }
            });
        }
    };
    
    self.renameAssignment = function(assignment) {
        new_name = window.prompt("Give a new name for this assignment:", assignment.name())
        if (new_name != null) {
            $.post("{{ url_for('blockpy.save_presentation') }}", {
                'name': new_name,
                'course_id': {{ course.id|tojson }},
                'assignment_id': assignment.id
            }, function(data) {
                if (data.success) {
                    assignment.name(new_name);
                    assignment.title(new_name);
                    self.groups.sort(self.group_comparison);
                } else {
                    console.error(data.message);
                }
            });
        }
    };
    
    
    self.moveGroup = function(move) {
        var group = this;
        $.post("{{ url_for('assignment_group.edit_group') }}", {
            'move': move,
            'course_id': {{ course.id|tojson }},
            'assignment_group_id': this.id
        }, function(data) {
            if (data.success) {
                group.position(data.position);
                self.groups.sort(self.group_comparison);
            } else {
                console.error(data.message);
            }
        });
    };
    
    self.addGroup = function() {
        $.post("{{ url_for('assignment_group.add_group') }}", {
                'course_id': {{ course.id|tojson }}
        }, function(data) {
            if (data.success) {
                self.groups.push({
                    'id': data.id,
                    'name': ko.observable(data.name),
                    'assignments': ko.observableArray()
                });
                self.groups.sort(self.group_comparison);
            } else {
                console.error(data.message);
            }
        });
    };
    
    self.removeGroup = function() {
        var that = this;
        if (this.id == -1) {
            // Can't delete the Stray group.
            return false;
        }
        $.post("{{ url_for('assignment_group.remove_group') }}", {
            'assignment_group_id': that.id,
            'course_id': {{ course.id|tojson }}
        }, function(data) {
            if (data.success) {
                self.groups.remove(that);
            } else {
                console.error(data.message);
            }
        });
    }
    
    self.removeAssignment = function(parent_group, assignment) {
        var youSureHuh = confirm("Are you really sure you want to delete this assignment?");
        if (youSureHuh != null) {
            $.post("{{ url_for('assignments.remove_assignment') }}", {
                'assignment_id': assignment.id,
                'course_id': {{ course.id|tojson }}
            }, function(data) {
                if (data.success) {
                    parent_group.assignments.remove(function(item) { return item.id == assignment.id });
                } else {
                    console.error(data.message);
                }
            });
        }
    }
    
    self.addExplainer = function() {self.addAssignment('explain')}
    self.addBlockPy = function() {self.addAssignment('normal')}
    self.addMaze = function() {self.addAssignment('maze')}
    
    self.addAssignment = function(type) {
        $.post("{{ url_for('assignments.new_assignment') }}", {
            'menu': "{{ menu }}",
            'course_id': {{ course.id|tojson }},
            'type': type
        }, function(data) {
            if (data.success) {
                self.strayGroup.assignments.unshift({
                    'id': data.id,
                    'group_id': -1,
                    'name': ko.observable(data.name),
                    'title': ko.observable(data.title),
                    'type': ko.observable(data.type),
                    'view': ko.observable(data.view),
                    'select': "{{ return_url }}?url="+data.select,
                    'edit': data.edit,
                    'modified': ko.observable(data.date_modified),
                    'body': ko.observable(data.body)
                });
                //window.open(data.redirect);
            } else {
                console.error(data.message);
            }
        });
    };
    
    self.refreshAssignment = function(assignment) {
        $.post("{{ url_for('assignments.get_assignment') }}", {
            'assignment_id': assignment.id,
            'course_id': {{ course.id|tojson }}
        }, function(data) {
            if (data.success) {
                assignment.name(data.name);
                assignment.title(data.title);
                assignment.body(data.body);
                assignment.modified(data.date_modified);
            } else {
                console.error(data.message);
            }
        });
    };
}
mainModel = new MainModel();
$().ready(function() {
    ko.applyBindings(mainModel);
});


</script>
<style>
.btn-group {
    display: flex;
}

.table-hover tbody tr:hover td, .table-hover tbody tr:hover th {
    background-color: #e9eaed;
}

tr:hover.hover-movers-rows .mover-buttons {
    visibility: visible;
}

tr.hover-movers-rows .mover-buttons {
    visibility: hidden;
}

tr:hover.hover-remove-rows button.remove-button {
    visibility: visible;
}

tr.hover-remove-rows button.remove-button {
    visibility: hidden;
}

</style>
{% endblock %}

{% block body %}

<a href="javascript:location.reload(true)" class='pull-right'><span class='glyphicon glyphicon-refresh' aria-hidden="true"></span></a>
<h3>Choose {{'an Assignment' if menu != 'share' else 'an Ungraded Assignment'}}</h3>

<a href="{{ url_for('courses.course', course_id=course.id) }}">Back to course</a>

<div class="btn-group">
  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Create an Assignment <span class="caret"></span>
  </button>
  <ul class="dropdown-menu">
    <li><a href="#" data-bind="click: $root.addBlockPy">BlockPy</a></li>
    <li><a href="#" data-bind="click: $root.addMaze" >Blockly Maze</a></li>
    <li><a href="#" data-bind="click: $root.addExplainer" >Code Explainer</a></li>
  </ul>
  
  <a href="#" data-bind="click: $root.addGroup " class="btn btn-default">Create new Group</a>
</div>

<table class="table table-condensed table-hover">
<tbody>
    <!-- ko foreach: groups -->
    <tr class="active hover-remove-rows">
        <td class="col-md-12 col-sm-12 col-xs-12" colspan="2">
            <a href="#" data-bind="click: $root.renameGroup"><strong data-bind="text: name"></strong></a>
        </td>
        <td>
            <button class='remove-button btn btn-danger btn-xs' type='button' data-bind="click: $root.removeGroup">
                <span class='glyphicon glyphicon-remove' aria-hidden="true"></span>
            </button>
            <!--
            <button class='remove-button btn btn-default btn-xs' type='button' data-bind="click: $root.moveGroup.bind($data, -1)">
                <span class='glyphicon glyphicon-chevron-up' aria-hidden="true"></span>
            </button>
            <button class='remove-button btn btn-default btn-xs' type='button' data-bind="click: $root.moveGroup.bind($data, 1)">
                <span class='glyphicon glyphicon-chevron-down' aria-hidden="true"></span>
            </button>-->
        </td>
    </tr>
    <!-- ko foreach: assignments -->
    <tr class='hover-movers-rows'>
        <td class='col-md-3 col-sm-3 col-xs-3'>
            <strong class="label label-default" data-bind="text: type"></strong> - <a data-bind="attr: {href: view}, text: title"></a>
            <br>
            Last modified at
            <span data-bind="text: modified"></span>
        </td>
        <td class='col-md-4 col-sm-4 col-xs-4'>
            <span data-bind="text: body"></span>
        </td>
        <td class='col-md-2 col-sm-2 col-xs-2'>
            <div class="mover-buttons">
              <a class='btn btn-default btn-xs ' data-bind="attr: { href: edit }">
                <span class='glyphicon glyphicon-pencil' aria-hidden="true"></span>
              </a>
              <button class='rename-button btn btn-default btn-xs' type='button' data-bind="click: $root.renameAssignment">
                Rename
              </button>
              <button class='remove-button btn btn-danger btn-xs' type='button' data-bind="click: $root.removeAssignment.bind($data, $parent)">
                <span class='glyphicon glyphicon-remove' aria-hidden="true"></span>
              </button>
              <!--<button class='remove-button btn btn-default btn-xs' type='button' data-bind="click: $root.moveAssignment">
                 <span class='glyphicon glyphicon-chevron-up' aria-hidden="true"></span>
              </button>
              <button class='remove-button btn btn-default btn-xs' type='button' data-bind="click: $root.moveAssignment">
                 <span class='glyphicon glyphicon-chevron-down' aria-hidden="true"></span>
              </button>-->
              <div class='btn-group' style='float:right'>
              <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                move to <span class="caret"></span>
              </button>
              <ul class="dropdown-menu dropdown-menu-right" data-bind="foreach: $root.groups">
                  <li><a href="#" data-bind="click: $root.moveMembership.bind($data, $parent, $parents[1]), text: name"></a></li>
              </ul>
              </div>
            </div>
        </td>
    </tr>
    <!-- /ko -->
    <!-- /ko -->
</tbody>
</table>


{% endblock %}